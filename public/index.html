<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asylumgram</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
body {
  margin:0;
  font-family:Arial;
  display:flex;
  height:100vh;
  background:#0f0f0f;
  color:white;
}

#sidebar {
  width:260px;
  background:#1a1a1a;
  padding:10px;
  box-sizing:border-box;
  overflow-y:auto;
}

#sidebar h2 {
  color:#4cafef;
  margin:0 0 10px 0;
}

.user {
  padding:8px;
  cursor:pointer;
  border-radius:6px;
  display:flex;
  align-items:center;
  gap:8px;
}

.user:hover { background:#333; }

.dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:#4caf50;
}

#chat {
  flex:1;
  display:flex;
  flex-direction:column;
}

#chatHeader {
  padding:15px;
  border-bottom:1px solid #333;
  background:#1a1a1a;
}

#messages {
  flex:1;
  padding:10px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}

.message {
  margin-bottom:10px;
  padding:8px;
  border-radius:10px;
  max-width:75%;
  word-wrap:break-word;
}

.me { background:#4cafef; align-self:flex-end; }
.other { background:#333; align-self:flex-start; }

.message img {
  max-width:200px;
  border-radius:8px;
  margin-top:5px;
}

#inputArea {
  display:flex;
  padding:10px;
  border-top:1px solid #333;
  background:#1a1a1a;
}

#msgInput {
  flex:1;
  padding:8px;
  border:none;
  border-radius:6px;
}

#sendBtn {
  margin-left:5px;
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#4cafef;
  color:white;
}

@media (max-width:768px){
  #sidebar { width:100px; }
  .user span { display:none; }
}
</style>
</head>

<body>

<div id="sidebar">
  <h2>Asylumgram</h2>
  <input id="username" placeholder="Имя"><br><br>
  <button onclick="login()">Войти</button>
  <hr>
  <div id="users"></div>
</div>

<div id="chat">
  <div id="chatHeader">Глобальный чат</div>
  <div id="messages"></div>

  <div id="inputArea">
    <input type="file" id="photoInput" accept="image/*">
    <input id="msgInput" placeholder="Сообщение...">
    <button id="sendBtn">➤</button>
  </div>
</div>

<script>
const socket = io();
let myName="";
let currentChat="global";

function login(){
  myName=document.getElementById("username").value.trim();
  if(!myName) return alert("Введите имя");
  socket.emit("join", myName);
}

document.getElementById("sendBtn").onclick=sendMessage;
document.getElementById("msgInput").addEventListener("keydown",e=>{
  if(e.key==="Enter") sendMessage();
});

function sendMessage(){
  const text=document.getElementById("msgInput").value.trim();
  const file=document.getElementById("photoInput").files[0];

  if(file){
    const reader=new FileReader();
    reader.onload=()=>{
      sendData("image",reader.result);
    };
    reader.readAsDataURL(file);
    document.getElementById("photoInput").value="";
  }

  if(text){
    sendData("text",text);
    document.getElementById("msgInput").value="";
  }
}

function sendData(type,content){
  if(currentChat==="global"){
    socket.emit("send_global",{type,content});
  } else {
    socket.emit("send_private",{to:currentChat,type,content});
  }
}

socket.on("users",list=>{
  const div=document.getElementById("users");
  div.innerHTML="";

  list.forEach(user=>{
    if(user!==myName){
      const u=document.createElement("div");
      u.className="user";
      u.innerHTML=`<div class="dot"></div><span>${user}</span>`;
      u.onclick=()=>{
        currentChat=user;
        document.getElementById("chatHeader").innerText=user;
        document.getElementById("messages").innerHTML="";
        socket.emit("load_private",user);
      };
      div.appendChild(u);
    }
  });
});

socket.on("new_global",data=>{
  if(currentChat!=="global") return;
  addMessage(data.user,data.type,data.content);
});

socket.on("new_private",data=>{
  if(currentChat!==data.from && currentChat!==data.to) return;
  addMessage(data.from,data.type,data.content);
});

socket.on("private_history",history=>{
  history.forEach(msg=>{
    addMessage(msg.from,msg.type,msg.content);
  });
});

function addMessage(user,type,content){
  const div=document.createElement("div");
  div.className="message "+(user===myName?"me":"other");

  if(type==="text"){
    div.innerText=user+": "+content;
  } else {
    div.innerHTML=user+":<br><img src='"+content+"'>";
  }

  document.getElementById("messages").appendChild(div);
}
</script>

</body>
</html>