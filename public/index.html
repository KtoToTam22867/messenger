<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Messenger</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
body {
  margin:0;
  background:#1e1e1e;
  color:white;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

#callScreen {
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  width:100%;
  height:100%;
}

.avatar {
  width:120px;
  height:120px;
  border-radius:50%;
  background:#555;
  margin-bottom:15px;
}

#status {
  opacity:0.7;
  margin-bottom:30px;
}

.controls {
  display:flex;
  gap:20px;
}

.controls button {
  width:60px;
  height:60px;
  border-radius:50%;
  border:none;
  font-size:20px;
  cursor:pointer;
}

.red { background:#e53935; color:white; }
.gray { background:#333; color:white; }
.green { background:#2e7d32; color:white; }

#mainMenu {
  text-align:center;
}
</style>
</head>

<body>

<div id="mainMenu">
  <h2>Messenger</h2>
  <input id="username" placeholder="Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ"><br><br>
  <input id="callTo" placeholder="ÐšÐ¾Ð¼Ñƒ Ð·Ð²Ð¾Ð½Ð¸Ñ‚ÑŒ"><br><br>
  <button onclick="startCall()" class="green">ÐŸÐ¾Ð·Ð²Ð¾Ð½Ð¸Ñ‚ÑŒ</button>
</div>

<div id="callScreen">
  <div class="avatar"></div>
  <h2 id="callName"></h2>
  <div id="status">Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ...</div>

  <div class="controls">
    <button class="gray" onclick="toggleScreen()">ðŸ–¥</button>
    <button class="gray" onclick="toggleCamera()">ðŸ“·</button>
    <button class="red" onclick="endCall()">ðŸ“ž</button>
    <button class="gray" onclick="toggleMic()">ðŸŽ¤</button>
  </div>
</div>

<audio id="remoteAudio" autoplay></audio>

<script>
const socket = io();

let myName;
let currentUser;
let localStream = null;
let peer = null;
let micEnabled = true;
let camEnabled = false;

// ===== Ð—ÐÐŸÐ£Ð¡Ðš Ð—Ð’ÐžÐÐšÐ =====
async function startCall() {
  myName = document.getElementById("username").value.trim();
  currentUser = document.getElementById("callTo").value.trim();

  if (!myName || !currentUser) return alert("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼ÐµÐ½Ð°");

  socket.emit("join", myName);

  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      audio:true,
      video:true
    });
  } catch(e) {
    alert("Ð Ð°Ð·Ñ€ÐµÑˆÐ¸ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½");
    return;
  }

  document.getElementById("mainMenu").style.display="none";
  document.getElementById("callScreen").style.display="flex";
  document.getElementById("callName").innerText=currentUser;

  createPeer();

  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);

  socket.emit("call-user", {
    from:myName,
    to:currentUser,
    offer
  });
}

// ===== Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• PEER =====
function createPeer() {
  peer = new RTCPeerConnection();

  localStream.getTracks().forEach(track=>{
    peer.addTrack(track, localStream);
  });

  peer.ontrack = e=>{
    document.getElementById("remoteAudio").srcObject=e.streams[0];
    document.getElementById("status").innerText="Ð’Ñ‹Ð·Ð¾Ð² Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½";
  };

  peer.onicecandidate = e=>{
    if(e.candidate){
      socket.emit("ice-candidate",{
        to:currentUser,
        candidate:e.candidate
      });
    }
  };
}

// ===== ÐŸÐ Ð˜ÐÐ˜ÐœÐÐ•Ðœ Ð—Ð’ÐžÐÐžÐš =====
socket.on("incoming-call", async data=>{
  myName = prompt("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ");
  currentUser = data.from;

  socket.emit("join", myName);

  localStream = await navigator.mediaDevices.getUserMedia({
    audio:true,
    video:true
  });

  document.getElementById("mainMenu").style.display="none";
  document.getElementById("callScreen").style.display="flex";
  document.getElementById("callName").innerText=currentUser;

  createPeer();

  await peer.setRemoteDescription(new RTCSessionDescription(data.offer));
  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);

  socket.emit("answer-call",{
    to:data.from,
    answer
  });
});

socket.on("call-answered", async data=>{
  await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
});

socket.on("ice-candidate", async candidate=>{
  if(peer && peer.remoteDescription){
    await peer.addIceCandidate(new RTCIceCandidate(candidate));
  }
});

// ===== ÐšÐÐžÐŸÐšÐ˜ =====
function toggleMic(){
  if(!localStream) return;
  micEnabled=!micEnabled;
  localStream.getAudioTracks()[0].enabled=micEnabled;
}

function toggleCamera(){
  if(!localStream) return;
  camEnabled=!camEnabled;
  localStream.getVideoTracks()[0].enabled=camEnabled;
}

async function toggleScreen(){
  const screen=await navigator.mediaDevices.getDisplayMedia({video:true});
  const sender=peer.getSenders().find(s=>s.track.kind==="video");
  sender.replaceTrack(screen.getVideoTracks()[0]);
}

function endCall(){
  if(peer) peer.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  location.reload();
}
</script>

</body>
</html>