<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asylumgram</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{
margin:0;
font-family:Arial;
background:#121212;
color:white;
height:100vh;
display:flex;
}

#auth{
position:absolute;
width:100%;
height:100%;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
background:#121212;
}

#auth input{
padding:10px;
margin:5px;
border:none;
border-radius:8px;
width:220px;
}

#auth button{
padding:10px;
margin:5px;
border:none;
border-radius:8px;
background:#2196f3;
color:white;
}

#app{display:none;width:100%;}

#sidebar{
width:230px;
background:#1e1e1e;
padding:10px;
overflow-y:auto;
}

.user{
padding:6px;
cursor:pointer;
display:flex;
align-items:center;
gap:6px;
}

.dot{
width:8px;height:8px;border-radius:50%;background:lime;
}

#chat{
flex:1;
display:flex;
flex-direction:column;
background-size:cover;
background-position:center;
}

#messages{
flex:1;
overflow-y:auto;
padding:10px;
display:flex;
flex-direction:column;
}

.msg{
display:flex;
gap:8px;
max-width:75%;
margin:6px 0;
padding:8px;
border-radius:12px;
}

.me{background:#2196f3;align-self:flex-end;}
.other{background:#333;align-self:flex-start;}

.avatar{
width:32px;
height:32px;
border-radius:50%;
object-fit:cover;
}

#bottom{
display:flex;
padding:10px;
background:#1a1a1a;
gap:5px;
}

#input{
flex:1;
padding:10px;
border:none;
border-radius:20px;
background:#2a2a2a;
color:white;
}

button{
border:none;
padding:8px 12px;
border-radius:20px;
background:#2196f3;
color:white;
cursor:pointer;
}

img.chatImg{
max-width:200px;
border-radius:10px;
margin-top:5px;
}

audio{
margin-top:5px;
}
</style>
</head>
<body>

<div id="auth">
<h2>Asylumgram</h2>
<input id="u" placeholder="–ù–∏–∫">
<input id="p" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button onclick="login()">–í—Ö–æ–¥</button>
<div id="err" style="color:red;"></div>
</div>

<div id="app">

<div id="sidebar">
<h3>–û–Ω–ª–∞–π–Ω</h3>
<div id="users"></div>
<hr>
<input type="file" id="avatarInput">
<button onclick="setAvatar()">–ê–≤–∞—Ç–∞—Ä</button>
<input type="file" id="bgInput">
<button onclick="setBg()">–û–±–æ–∏</button>
</div>

<div id="chat">
<div id="messages"></div>
<div id="bottom">
<input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
<input type="file" id="imgInput" hidden>
<button onclick="send()">‚û§</button>
<button onclick="imgInput.click()">üì∑</button>
<button onclick="recordVoice()">üé§</button>
</div>
</div>

</div>

<script>
const socket=io();
let username=null;
let avatar=null;
let currentChat="global";
let mediaRecorder;

function register(){
socket.emit("register",{username:u.value,password:p.value},res=>{
if(res.success) alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
else err.innerText=res.message;
});
}

function login(){
socket.emit("login",{username:u.value,password:p.value},res=>{
if(res.success){
username=u.value;
avatar=res.avatar;
auth.style.display="none";
app.style.display="flex";
}else err.innerText=res.message;
});
}

socket.on("online",list=>{
users.innerHTML="";
list.forEach(user=>{
if(user!==username){
let div=document.createElement("div");
div.className="user";
div.innerHTML='<div class="dot"></div>'+user;
div.onclick=()=>{currentChat=user;messages.innerHTML="";};
users.appendChild(div);
}
});
});

function send(){
if(!input.value) return;

socket.emit("send_message",{
from:username,
to:currentChat,
text:input.value,
avatar
});

input.value="";
}

socket.on("new_message",addMessage);

function addMessage(msg){
let div=document.createElement("div");
div.className="msg "+(msg.from===username?"me":"other");

if(msg.avatar){
let img=document.createElement("img");
img.src=msg.avatar;
img.className="avatar";
div.appendChild(img);
}

let content=document.createElement("div");

if(msg.image){
let img=document.createElement("img");
img.src=msg.image;
img.className="chatImg";
content.appendChild(img);
}
else if(msg.voice){
let audio=document.createElement("audio");
audio.controls=true;
audio.src=msg.voice;
content.appendChild(audio);
}
else{
content.innerText=msg.from+": "+msg.text;
}

div.appendChild(content);
messages.appendChild(div);
messages.scrollTop=messages.scrollHeight;
}

imgInput.onchange=e=>{
let reader=new FileReader();
reader.onload=()=>{
socket.emit("send_message",{
from:username,
to:currentChat,
image:reader.result,
avatar
});
};
reader.readAsDataURL(e.target.files[0]);
};

function recordVoice(){
navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
mediaRecorder=new MediaRecorder(stream);
let chunks=[];
mediaRecorder.ondataavailable=e=>chunks.push(e.data);
mediaRecorder.onstop=()=>{
let blob=new Blob(chunks);
let reader=new FileReader();
reader.onload=()=>{
socket.emit("send_message",{
from:username,
to:currentChat,
voice:reader.result,
avatar
});
};
reader.readAsDataURL(blob);
};
mediaRecorder.start();
setTimeout(()=>mediaRecorder.stop(),3000);
});
}

function setAvatar(){
let file=avatarInput.files[0];
let reader=new FileReader();
reader.onload=()=>{
avatar=reader.result;
socket.emit("setAvatar",reader.result);
};
reader.readAsDataURL(file);
}

function setBg(){
let file=bgInput.files[0];
let reader=new FileReader();
reader.onload=()=>chat.style.backgroundImage="url("+reader.result+")";
reader.readAsDataURL(file);
}
</script>

</body>
</html>