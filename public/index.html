<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asylumgram</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{
margin:0;
font-family:Arial;
height:100vh;
display:flex;
background:#121212;
color:white;
}
#auth{
position:absolute;
width:100%;
height:100%;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
background:#121212;
}
#auth input{
padding:10px;
margin:5px;
border:none;
border-radius:8px;
width:220px;
}
#auth button{
padding:10px;
margin:5px;
border:none;
border-radius:8px;
background:#2196f3;
color:white;
cursor:pointer;
}
#app{display:none;width:100%;}
#sidebar{
width:240px;
background:#1e1e1e;
padding:10px;
overflow-y:auto;
}
.user{
padding:6px;
cursor:pointer;
display:flex;
align-items:center;
}
.onlineDot{
width:8px;height:8px;border-radius:50%;background:lime;margin-right:6px;
}
#chat{
flex:1;
display:flex;
flex-direction:column;
background-size:cover;
background-position:center;
}
#messages{
flex:1;
overflow-y:auto;
padding:10px;
display:flex;
flex-direction:column;
}
.msg{
max-width:70%;
padding:8px 12px;
margin:5px 0;
border-radius:12px;
}
.me{background:#2196f3;align-self:flex-end;}
.other{background:#333;align-self:flex-start;}
#bottom{
display:flex;
padding:10px;
background:#1a1a1a;
}
#input{
flex:1;
padding:10px;
border:none;
border-radius:20px;
background:#2a2a2a;
color:white;
}
button{
margin-left:5px;
border:none;
padding:8px 12px;
border-radius:20px;
background:#2196f3;
color:white;
cursor:pointer;
}
img.chatImage{max-width:200px;border-radius:10px;margin-top:5px;}
</style>
</head>
<body>

<div id="auth">
<h2>Asylumgram</h2>
<input id="u" placeholder="–ù–∏–∫">
<input id="p" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button onclick="login()">–í—Ö–æ–¥</button>
<div id="err" style="color:red;"></div>
</div>

<div id="app">
<div id="sidebar">
<h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
<div id="users"></div>
<hr>
<input type="file" id="avatarInput">
<button onclick="setAvatar()">–ê–≤–∞—Ç–∞—Ä</button>
<input type="file" id="bgInput">
<button onclick="setBg()">–û–±–æ–∏</button>
</div>

<div id="chat">
<div id="messages"></div>
<div id="bottom">
<input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
<input type="file" id="imgInput" style="display:none">
<button onclick="send()">‚û§</button>
<button onclick="document.getElementById('imgInput').click()">üì∑</button>
<button onclick="recordVoice()">üé§</button>
</div>
</div>
</div>

<script>
const socket=io();
let username=null;
let onlineUsers=[];
let mediaRecorder;
let currentChat="global";

function register(){
socket.emit("register",{username:u.value,password:p.value},res=>{
if(res.success) alert("–£—Å–ø–µ—à–Ω–æ");
else err.innerText=res.message;
});
}

function login(){
socket.emit("login",{username:u.value,password:p.value},res=>{
if(res.success){
username=u.value;
auth.style.display="none";
app.style.display="flex";
}else err.innerText=res.message;
});
}

socket.on("online",list=>{
onlineUsers=list;
users.innerHTML="";
list.forEach(u=>{
if(u!==username){
let div=document.createElement("div");
div.className="user";
div.innerHTML='<div class="onlineDot"></div>'+u;
div.onclick=()=>{currentChat=u;messages.innerHTML="";};
users.appendChild(div);
}
});
});

function send(){
if(!input.value) return;
let msg={from:username,text:input.value};
if(currentChat==="global")
socket.emit("send_global",msg);
else
socket.emit("send_private",{...msg,to:currentChat});
input.value="";
}

socket.on("new_global",addMsg);
socket.on("new_private",addMsg);

function addMsg(msg){
let div=document.createElement("div");
div.className="msg "+(msg.from===username?"me":"other");
if(msg.image){
div.innerHTML=msg.from+"<br><img class='chatImage' src='"+msg.image+"'>";
}
else if(msg.voice){
let audio=document.createElement("audio");
audio.controls=true;
audio.src=msg.voice;
div.innerText=msg.from;
div.appendChild(document.createElement("br"));
div.appendChild(audio);
}
else{
div.innerText=msg.from+": "+msg.text;
}
messages.appendChild(div);
messages.scrollTop=messages.scrollHeight;
}

imgInput.onchange=e=>{
let reader=new FileReader();
reader.onload=()=>{
let msg={from:username,image:reader.result};
socket.emit("send_global",msg);
};
reader.readAsDataURL(e.target.files[0]);
};

function setAvatar(){
let file=avatarInput.files[0];
let reader=new FileReader();
reader.onload=()=>socket.emit("setAvatar",reader.result);
reader.readAsDataURL(file);
}

function setBg(){
let file=bgInput.files[0];
let reader=new FileReader();
reader.onload=()=>chat.style.backgroundImage="url("+reader.result+")";
reader.readAsDataURL(file);
}

function recordVoice(){
navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
mediaRecorder=new MediaRecorder(stream);
let chunks=[];
mediaRecorder.ondataavailable=e=>chunks.push(e.data);
mediaRecorder.onstop=()=>{
let blob=new Blob(chunks);
let reader=new FileReader();
reader.onload=()=>{
let msg={from:username,voice:reader.result};
socket.emit("send_global",msg);
};
reader.readAsDataURL(blob);
};
mediaRecorder.start();
setTimeout(()=>mediaRecorder.stop(),3000);
});
}
</script>
</body>
</html>