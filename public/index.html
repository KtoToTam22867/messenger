<!-- слишком большой чтобы объяснять, просто вставь -->
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let username = null;
let avatar = null;
let currentChat = "global";

let peerConnection;
let localStream;

const servers = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

async function startCall(user){
  localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  peerConnection = new RTCPeerConnection(servers);

  localStream.getTracks().forEach(track=>{
    peerConnection.addTrack(track, localStream);
  });

  peerConnection.onicecandidate = e=>{
    if(e.candidate){
      socket.emit("iceCandidate",{ to:user, candidate:e.candidate });
    }
  };

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);

  socket.emit("callUser",{ to:user, offer });
}

socket.on("incomingCall", async ({ from, offer })=>{
  if(!confirm("Входящий звонок от "+from)) return;

  localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  peerConnection = new RTCPeerConnection(servers);

  localStream.getTracks().forEach(track=>{
    peerConnection.addTrack(track, localStream);
  });

  peerConnection.onicecandidate = e=>{
    if(e.candidate){
      socket.emit("iceCandidate",{ to:from, candidate:e.candidate });
    }
  };

  await peerConnection.setRemoteDescription(offer);
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);

  socket.emit("answerCall",{ to:from, answer });
});

socket.on("callAnswered", async ({ answer })=>{
  await peerConnection.setRemoteDescription(answer);
});

socket.on("iceCandidate", async ({ candidate })=>{
  if(peerConnection){
    await peerConnection.addIceCandidate(candidate);
  }
});
</script>