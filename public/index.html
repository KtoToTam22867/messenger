<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Asylumgram</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
body {
  margin:0;
  font-family:Arial;
  display:flex;
  height:100vh;
  background:#0f0f0f;
  color:white;
}

#sidebar {
  width:250px;
  background:#1a1a1a;
  padding:15px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
}

#sidebar h2 {
  color:#4cafef;
  margin:0 0 10px 0;
}

#users {
  flex:1;
  overflow-y:auto;
}

.user {
  padding:8px;
  cursor:pointer;
  border-radius:6px;
}

.user:hover {
  background:#333;
}

#chat {
  flex:1;
  display:flex;
  flex-direction:column;
}

#chatHeader {
  padding:15px;
  border-bottom:1px solid #333;
  background:#1a1a1a;
}

#messages {
  flex:1;
  padding:15px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}

.message {
  margin-bottom:10px;
  padding:8px 12px;
  border-radius:10px;
  max-width:60%;
}

.me {
  background:#4cafef;
  align-self:flex-end;
}

.other {
  background:#333;
  align-self:flex-start;
}

#inputArea {
  display:flex;
  padding:10px;
  border-top:1px solid #333;
  background:#1a1a1a;
}

#msgInput {
  flex:1;
  padding:8px;
  border:none;
  border-radius:6px;
  outline:none;
}

#sendBtn {
  margin-left:10px;
  padding:8px 15px;
  border:none;
  border-radius:6px;
  background:#4cafef;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="sidebar">
  <h2>Asylumgram</h2>
  <input id="username" placeholder="–í–∞—à–µ –∏–º—è"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏</button>
  <hr>
  <div id="users"></div>
</div>

<div id="chat">
  <div id="chatHeader">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</div>
  <div id="messages"></div>
  <div id="inputArea">
    <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script>
const socket = io();

let myName = "";
let currentChat = "global";

function login(){
  const name = document.getElementById("username").value.trim();
  if(!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
  myName = name;
  socket.emit("join", name);
}

document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("msgInput").addEventListener("keydown", e=>{
  if(e.key==="Enter") sendMessage();
});

function sendMessage(){
  const text = document.getElementById("msgInput").value.trim();
  if(!text) return;

  if(currentChat==="global"){
    socket.emit("send_global", text);
  } else {
    socket.emit("send_private", { to: currentChat, message:text });
  }

  document.getElementById("msgInput").value="";
}

socket.on("users", list=>{
  const usersDiv = document.getElementById("users");
  usersDiv.innerHTML="";

  const globalDiv = document.createElement("div");
  globalDiv.className="user";
  globalDiv.innerText="üåç –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç";
  globalDiv.onclick=()=>{
    currentChat="global";
    document.getElementById("chatHeader").innerText="–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç";
    document.getElementById("messages").innerHTML="";
    socket.emit("load_global");
  };
  usersDiv.appendChild(globalDiv);

  list.forEach(user=>{
    if(user!==myName){
      const div=document.createElement("div");
      div.className="user";
      div.innerText=user;
      div.onclick=()=>{
        currentChat=user;
        document.getElementById("chatHeader").innerText=user;
        document.getElementById("messages").innerHTML="";
        socket.emit("load_private", user);
      };
      usersDiv.appendChild(div);
    }
  });
});

socket.on("load_global", history=>{
  document.getElementById("messages").innerHTML="";
  history.forEach(addGlobalMessage);
});

socket.on("new_global", addGlobalMessage);

function addGlobalMessage(data){
  const div=document.createElement("div");
  div.className="message "+(data.user===myName?"me":"other");
  div.innerText=data.user+": "+data.message;
  document.getElementById("messages").appendChild(div);
}

socket.on("private_history", history=>{
  document.getElementById("messages").innerHTML="";
  history.forEach(addPrivateMessage);
});

socket.on("new_private", addPrivateMessage);

function addPrivateMessage(data){
  if(currentChat==="global") return;
  if(data.from!==currentChat && data.to!==currentChat) return;

  const div=document.createElement("div");
  div.className="message "+(data.from===myName?"me":"other");
  div.innerText=(data.from===myName?"–í—ã":data.from)+": "+data.message;
  document.getElementById("messages").appendChild(div);
}
</script>

</body>
</html>