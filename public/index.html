<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Asylumgram</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{font-family:sans-serif;margin:0;background:#111;color:white}
#chat{display:none}
#messages{height:300px;overflow:auto;border:1px solid #444;padding:10px}
input,button{padding:8px;margin:5px}
button{background:#2196f3;color:white;border:none}
img{max-width:150px;border-radius:10px;margin-top:5px}
.online{color:#0f0}
</style>
</head>
<body>

<div id="auth">
<h2>Asylumgram</h2>
<input id="username" placeholder="Username"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="register()">Register</button>
<button onclick="login()">Login</button>
</div>

<div id="chat">
<h3 id="me"></h3>
<input type="file" id="avatarInput"><br>
<div>Online: <span id="onlineUsers"></span></div>
<hr>
<select id="toUser">
<option value="global">Global Chat</option>
</select>
<div id="messages"></div>
<input id="messageInput" placeholder="Message">
<input type="file" id="imageInput">
<button onclick="send()">Send</button>
</div>

<script>
const socket = io();
let myUsername = null;

function register(){
  socket.emit("register",{
    username:username.value,
    password:password.value
  },res=>{
    alert(res.success?"Registered":"Error");
  });
}

function login(){
  socket.emit("login",{
    username:username.value,
    password:password.value
  },res=>{
    if(!res.success) return alert("Error");

    myUsername=username.value;
    auth.style.display="none";
    chat.style.display="block";
    me.innerText="You: "+myUsername;

    if(res.avatar){
      let img=document.createElement("img");
      img.src=res.avatar;
      chat.prepend(img);
    }
  });
}

avatarInput.onchange=()=>{
  const file=avatarInput.files[0];
  const reader=new FileReader();
  reader.onload=()=>socket.emit("setAvatar",reader.result);
  reader.readAsDataURL(file);
};

function send(){
  const file=imageInput.files[0];

  if(file){
    const reader=new FileReader();
    reader.onload=()=>{
      socket.emit("send_message",{
        to:toUser.value,
        text:messageInput.value,
        image:reader.result
      });
    };
    reader.readAsDataURL(file);
  }else{
    socket.emit("send_message",{
      to:toUser.value,
      text:messageInput.value
    });
  }

  messageInput.value="";
  imageInput.value="";
}

socket.on("new_message",data=>{
  let div=document.createElement("div");
  div.innerHTML="<b>"+data.from+":</b> "+(data.text||"");
  if(data.image){
    let img=document.createElement("img");
    img.src=data.image;
    div.appendChild(img);
  }
  messages.appendChild(div);
});

socket.on("online",list=>{
  onlineUsers.innerHTML="";
  toUser.innerHTML='<option value="global">Global Chat</option>';

  list.forEach(u=>{
    onlineUsers.innerHTML+=`<span class="online">${u}</span> `;
    if(u!==myUsername){
      toUser.innerHTML+=`<option value="${u}">${u}</option>`;
    }
  });
});
</script>

</body>
</html>